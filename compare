- name: Comparaison de deux fichiers JSON
  hosts: localhost
  gather_facts: false
  vars:
    file1: "./file1.json"
    file2: "./file2.json"

  tasks:
    - name: Charger le contenu de file1.json
      ansible.builtin.include_vars:
        file: "{{ file1 }}"
        name: json1

    - name: Charger le contenu de file2.json
      ansible.builtin.include_vars:
        file: "{{ file2 }}"
        name: json2

    - name: Obtenir les clés uniquement dans file1
      set_fact:
        only_in_file1: "{{ json1.keys() | difference(json2.keys()) }}"

    - name: Obtenir les clés uniquement dans file2
      set_fact:
        only_in_file2: "{{ json2.keys() | difference(json1.keys()) }}"

    - name: Obtenir les clés communes
      set_fact:
        common_keys: "{{ json1.keys() | intersect(json2.keys()) }}"

    - name: Trouver les différences de valeurs
      set_fact:
        different_values: >-
          {{
            common_keys | selectattr(
              'json1[item] != json2[item]', 'true'
            ) | list
          }}
      vars:
        item: "{{ item }}"

    - name: Afficher les clés uniquement dans file1
      debug:
        msg: "Clés présentes uniquement dans file1.json : {{ only_in_file1 }}"

    - name: Afficher les clés uniquement dans file2
      debug:
        msg: "Clés présentes uniquement dans file2.json : {{ only_in_file2 }}"

    - name: Afficher les valeurs différentes
      debug:
        msg: >-
          {% for key in different_values %}
          Clé : {{ key }}
            - Valeur dans file1 : {{ json1[key] }}
            - Valeur dans file2 : {{ json2[key] }}
          {% endfor %}
